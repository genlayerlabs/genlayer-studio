name: Create releases from main
on:
  schedule:
    - cron: "00 08 * * 1-4" # 08:00 AM (UTC) from Monday to Thursday
  workflow_dispatch:
permissions:
  contents: read # for checkout

concurrency:
  group: release-please

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to publish a GitHub release
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests
      id-token: write # to enable use of OIDC for npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - name: Install dependencies
        run: npm install @semantic-release/github @semantic-release/release-notes-generator @semantic-release/commit-analyzer @semantic-release/npm conventional-changelog-conventionalcommits
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release # Uses `release.config.js` for configuration
  push-docker-images:
    name: Build images and push to DockerHub # Since GH Actions do not trigger other GH Actions (https://github.com/orgs/community/discussions/25702) we trigger it manually
    uses: ./.github/workflows/docker-build-and-push-all.yml
    needs: release
    secrets: inherit

  trigger-workload-release-lane:
    name: Trigger Workload Release Lane
    runs-on: ubuntu-latest
    needs: push-docker-images
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get CI Bot Token
        id: ci_bot_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.CI_BOT_APP_ID }}
          private_key: ${{ secrets.CI_BOT_SECRET }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve JSONRPC image digest
        id: digest
        run: |
          set -euo pipefail
          git fetch --tags --force
          latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
          image_ref="yeagerai/simulator-jsonrpc:${latest_tag}"

          digest=""
          for attempt in {1..20}; do
            digest="$(docker buildx imagetools inspect "$image_ref" --format '{{json .Manifest.Digest}}' 2>/dev/null | tr -d '\"' || true)"
            if [[ "$digest" == sha256:* ]]; then
              break
            fi
            echo "Digest not available yet for ${image_ref}; attempt ${attempt}/20"
            sleep 15
          done

          if [[ ! "$digest" == sha256:* ]]; then
            echo "Failed to resolve digest for ${image_ref}" >&2
            exit 1
          fi

          image_digest_ref="yeagerai/simulator-jsonrpc@${digest}"
          echo "latest_tag=${latest_tag}" >> "$GITHUB_OUTPUT"
          echo "image=${image_digest_ref}" >> "$GITHUB_OUTPUT"
          echo "Resolved digest reference: ${image_digest_ref}"

      - name: Resolve Consensus Worker image digest
        id: worker_digest
        run: |
          set -euo pipefail
          latest_tag='${{ steps.digest.outputs.latest_tag }}'
          if [[ -z "$latest_tag" ]]; then
            echo "Missing latest_tag output from digest step" >&2
            exit 1
          fi
          image_ref="yeagerai/simulator-consensus-worker:${latest_tag}"

          digest=""
          for attempt in {1..20}; do
            digest="$(docker buildx imagetools inspect "$image_ref" --format '{{json .Manifest.Digest}}' 2>/dev/null | tr -d '\"' || true)"
            if [[ "$digest" == sha256:* ]]; then
              break
            fi
            echo "Digest not available yet for ${image_ref}; attempt ${attempt}/20"
            sleep 15
          done

          if [[ ! "$digest" == sha256:* ]]; then
            echo "Failed to resolve digest for ${image_ref}" >&2
            exit 1
          fi

          image_digest_ref="yeagerai/simulator-consensus-worker@${digest}"
          echo "image=${image_digest_ref}" >> "$GITHUB_OUTPUT"
          echo "Resolved digest reference: ${image_digest_ref}"

      - name: Trigger workload release lane
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ steps.ci_bot_token.outputs.token }}
          repository: genlayerlabs/devexp-apps-workload
          event-type: release-backend
          client-payload: |
            {
              "image": "${{ steps.digest.outputs.image }}",
              "consensus_worker_image": "${{ steps.worker_digest.outputs.image }}"
            }
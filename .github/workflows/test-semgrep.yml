name: Semgrep OSS scan

on:
  push:
    branches:
      - main
      - sast-semgrep # Remove me after merge.
  schedule:
    - cron: '00 18 * * *' # Sets Semgrep to scan every day at 18:00 UTC.
  workflow_dispatch:

jobs:
  semgrep:
    name: semgrep-oss/scan
    runs-on: ubuntu-latest
    container:
      # A Docker image with Semgrep installed. Do not change this.
      image: semgrep/semgrep

    # Skip any PR created by dependabot to avoid permission issues:
    if: (github.actor != 'dependabot[bot]')
    steps:
      - uses: actions/checkout@v4

      - id: semgrep_scan
        run: semgrep scan --config auto --json > semgrep_results.json

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v3
        with:
          name: semgrep-results
          path: semgrep_results.json

      - name: Create GitHub comment with Semgrep results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const semgrepResults = fs.readFileSync('semgrep_results.json', 'utf8');
            const results = JSON.parse(semgrepResults);
            let commentBody = '';
            results.results.forEach(result => {
              commentBody += `### ${result.check_id}\n\n`;
              commentBody += `**File:** \`${result.path}\`\n`;
              commentBody += `**Line:** \`${result.start.line}\`\n`;
              commentBody += `**Message:** ${result.extra.message}\n\n`;
              commentBody += '---\n\n';
            });
            if (commentBody === '') {
              commentBody = 'No issues found by Semgrep.';
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
